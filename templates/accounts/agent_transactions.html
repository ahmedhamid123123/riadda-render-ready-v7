{% extends "base/base.html" %}
{% load currency %}

{% block content %}

<div class="card">
    <h2>تفاصيل العمليات</h2>

    <!-- ===== فلترة ===== -->
    <form method="get" class="form-margin-bottom mb-15" role="search" aria-label="فلترة العمليات">
        <label>الحالة:</label>
        <select name="status" title="الحالة" aria-label="الحالة">
            <option value="">الكل</option>
            <option value="CONFIRMED" {% if status_filter == 'CONFIRMED' %}selected{% endif %}>
                مؤكدة
            </option>
            <option value="PRINTED" {% if status_filter == 'PRINTED' %}selected{% endif %}>
                تمت الطباعة
            </option>
        </select>

        <button type="submit">فلترة</button>
        <a href="{% url 'agent_transactions' %}">إعادة تعيين</a>
    </form>

    <p>
        <strong>إجمالي العمولات (العمليات المؤكدة):</strong>
        {{ total_commission|iq_currency }}
    </p>
</div>

<div class="card">
    <table aria-label="تفاصيل العمليات">
        <caption>تفاصيل العمليات</caption>
        <thead>
            <tr>
                <th>التاريخ</th>
                <th>فئة الشحن</th>
                <th>الحالة</th>
                <th>العمولة</th>
                <th>الإيصال</th>
                <th>إعادة الإصدار</th>
            </tr>
        </thead>
        <tbody>
        {% for t in page_obj %}
            <tr>
                <td>{{ t.created_at }}</td>
                <td>{{ t.denomination }}</td>
                <td>
                    {% if t.status == 'CONFIRMED' %}
                        <span class="badge badge-success">مؤكدة</span>
                    {% elif t.status == 'PRINTED' %}
                        <span class="badge badge-danger">تمت الطباعة</span>
                    {% endif %}
                </td>
                <td>
                    {% if t.status == 'CONFIRMED' %}
                        {{ t.commission_amount|iq_currency }}
                    {% else %}
                        -
                    {% endif %}
                </td>

                <!-- ===== عرض الإيصال ===== -->
                <td>
                    {% if t.status == 'CONFIRMED' %}
                        <a href="{% url 'customer_receipt' t.public_token %}" target="_blank" rel="noopener noreferrer">
                            عرض الإيصال
                        </a>
                    {% else %}
                        -
                    {% endif %}
                </td>

                <!-- ===== إعادة الإصدار + المتبقي ===== -->
                <td>
                    {% if t.status == 'CONFIRMED' %}
                        {% with remaining=remaining_map.t.id %}
                            {% if remaining > 0 %}
                                <a href="{% url 'agent_reissue_receipt' t.id %}">
                                    إعادة إصدار
                                </a>
                                <br>
                                <small class="text-light-gray">
                                    متبقي: {{ remaining }} / {{ max_reissue }}
                                </small>
                            {% else %}
                                <span class="text-dark-gray">
                                    انتهى الحد
                                </span>
                            {% endif %}
                        {% endwith %}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="6">لا توجد عمليات</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- ===== Pagination ===== -->
    {% if page_obj.has_other_pages %}
    <div class="mt-15">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&status={{ status_filter }}">
                السابق
            </a>
        {% endif %}

        <span>
            صفحة {{ page_obj.number }} من {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&status={{ status_filter }}">
                التالي
            </a>
        {% endif %}
    </div>
    {% endif %}
</div>

{% endblock %}
